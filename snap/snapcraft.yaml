name: alacritty
adopt-info: alacritty

base: core20
grade: stable
confinement: classic
compression: lzo

apps:
  alacritty:
    command: bin/alacritty
    common-id: io.alacritty.Alacritty
    completer: usr/share/bash-completion/completions/alacritty
    desktop: usr/share/applications/Alacritty.desktop
    environment:
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      LIBGL_DRIVERS_PATH: $SNAP/usr/lib/x86_64-linux-gnu/dri
      __EGL_VENDOR_LIBRARY_DIRS: $SNAP/etc/glvnd/egl_vendor.d:$SNAP/usr/share/glvnd/egl_vendor.d

parts:
  mesa:
    plugin: nil
    stage-packages:
      - libgl1-mesa-dri
      - libglx-mesa0
    build-attributes:
      - no-patchelf

  alacritty:
    plugin: rust
    source: https://github.com/alacritty/alacritty.git
    source-tag: v0.8.0
    parse-info:
      - extra/linux/io.alacritty.Alacritty.appdata.xml
    rust-path:
      - alacritty
    build-packages:
      - cmake
      - pkg-config
      - libfreetype6-dev
      - libfontconfig1-dev
      - libxcb-xfixes0-dev
      - libxkbcommon-dev
      - python3
      - libegl1-mesa-dev # necessary for nvidia users on wayland
      - libxcb-render0-dev
      - libxcb-shape0-dev
      - libxcb1-dev
      - libgl1-mesa-dev
    stage-packages:
      - libfontconfig1
      - libfreetype6
      - libpng16-16
      - libxau6
      - libxcursor1
      - libxcb-render0
      - libxcb-shape0
      - libxcb-xfixes0
      - libxcb1
      - libxdmcp6
      - libxi6
      - libxrandr2
      - libffi7
      - libxkbcommon0
      - libnss-sss
    override-build: |
      version=$(git describe --match "v*" | cut -c2-)

      snapcraftctl set-version $version
      snapcraftctl build

      mkdir -p $SNAPCRAFT_PART_INSTALL/usr/share/applications \
          $SNAPCRAFT_PART_INSTALL/usr/share/icons \
          $SNAPCRAFT_PART_INSTALL/usr/share/bash-completion/completions

      cp extra/linux/Alacritty.desktop $SNAPCRAFT_PART_INSTALL/usr/share/applications/Alacritty.desktop
      cp extra/logo/compat/alacritty-term+scanlines.png $SNAPCRAFT_PART_INSTALL/usr/share/icons/Alacritty.png
      cp extra/completions/alacritty.bash $SNAPCRAFT_PART_INSTALL/usr/share/bash-completion/completions/alacritty

      sed -i 's|Icon=.*|Icon=${SNAP}/usr/share/icons/Alacritty.png|g' \
          $SNAPCRAFT_PART_INSTALL/usr/share/applications/Alacritty.desktop
